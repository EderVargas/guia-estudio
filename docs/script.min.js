const urlParams=new URLSearchParams(window.location.search),selectedSubject=urlParams.get("subject")||"lenguajes",SUBJECTS={matematicas:{title:"🔢 Matemáticas",jsonFile:"assets/matematicas.json",storagePrefix:"math_"},lenguajes:{title:"📚 Lenguajes",jsonFile:"assets/lenguajes.json",storagePrefix:"lang_"},conocimientoMedio:{title:"🌍 Conocimiento del Medio",jsonFile:"assets/conocimientoMedio.json",storagePrefix:"cm_"}},currentSubject=SUBJECTS[selectedSubject],QUESTIONS_PER_QUIZ=10,STORAGE_KEYS={ANSWERED_QUESTIONS:currentSubject.storagePrefix+"answeredQuestions",INCORRECT_QUESTIONS:currentSubject.storagePrefix+"incorrectQuestions"},storage=sessionStorage;let allQuestionsData=[],currentQuizQuestions=[],currentQuestionIndex=0,score=0,selectedAnswer=null;const questionText=document.getElementById("question-text"),answersContainer=document.getElementById("answers-container"),verifyBtn=document.getElementById("verify-btn"),nextBtn=document.getElementById("next-btn"),feedback=document.getElementById("feedback"),quizContainer=document.getElementById("quiz-container"),finalScreen=document.getElementById("final-screen"),finalScoreDisplay=document.getElementById("final-score"),restartBtn=document.getElementById("restart-btn"),currentQuestionDisplay=document.getElementById("current-question"),totalQuestionsDisplay=document.getElementById("total-questions"),scoreDisplay=document.getElementById("score"),confettiCanvas=document.getElementById("confetti-canvas"),infoBtn=document.getElementById("info-btn"),infoModal=document.getElementById("info-modal"),closeModal=document.querySelector(".close-modal"),modalInfoContent=document.getElementById("modal-info-content");function shuffleArray(e){const t=[...e];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function getAnsweredQuestions(){const e=storage.getItem(STORAGE_KEYS.ANSWERED_QUESTIONS);return e?new Set(JSON.parse(e)):new Set}function getIncorrectQuestions(){const e=storage.getItem(STORAGE_KEYS.INCORRECT_QUESTIONS);return e?new Set(JSON.parse(e)):new Set}function saveQuestionResult(e,t){const n=getAnsweredQuestions();n.add(e),storage.setItem(STORAGE_KEYS.ANSWERED_QUESTIONS,JSON.stringify([...n]));const s=getIncorrectQuestions();t?s.delete(e):s.add(e),storage.setItem(STORAGE_KEYS.INCORRECT_QUESTIONS,JSON.stringify([...s]))}function resetProgress(){storage.removeItem(STORAGE_KEYS.ANSWERED_QUESTIONS),storage.removeItem(STORAGE_KEYS.INCORRECT_QUESTIONS)}function selectQuestions(){const e=getAnsweredQuestions(),t=getIncorrectQuestions(),n=allQuestionsData.filter(e=>t.has(e.id)),s=allQuestionsData.filter(n=>!e.has(n.id)&&!t.has(n.id));if(0===n.length&&0===s.length)return resetProgress(),selectQuestions();let r=[];if(r.push(...shuffleArray(n)),r.length<10){const e=10-r.length;r.push(...shuffleArray(s).slice(0,e))}return shuffleArray(r.slice(0,10))}function getProgressStats(){const e=getAnsweredQuestions(),t=getIncorrectQuestions(),n=allQuestionsData.length,s=n-e.size;return{total:n,answered:e.size,remaining:s,incorrect:t.size}}async function loadQuestions(){try{const e=document.getElementById("quiz-title");e&&(e.textContent=currentSubject.title);const t=await fetch(currentSubject.jsonFile),n=await t.json();allQuestionsData=n.data,currentQuizQuestions=selectQuestions(),totalQuestionsDisplay.textContent=currentQuizQuestions.length,displayQuestion()}catch(e){console.error("Error al cargar las preguntas:",e),questionText.textContent="Error al cargar las preguntas. Por favor, recarga la página."}}function displayProgressInfo(){const e=getProgressStats(),t=getIncorrectQuestions();let n="";if(currentQuizQuestions.length>0&&currentQuestionIndex<currentQuizQuestions.length){n+='<div class="stat-row" style="background-color: #e3f2fd;">',n+=`<p><strong>ID de pregunta actual:</strong> ${currentQuizQuestions[currentQuestionIndex].id}</p>`,n+="</div>"}n+='<div class="stat-row">',n+=`<p><strong>Total de preguntas:</strong> ${e.total}</p>`,n+="</div>",n+='<div class="stat-row">',n+=`<p><strong>Respondidas correctamente:</strong> ${e.answered}</p>`,n+="</div>",n+='<div class="stat-row">',n+=`<p><strong>Preguntas restantes:</strong> ${e.remaining}</p>`,n+="</div>",t.size>0&&(n+='<div class="warning">',n+=`<p><strong>Atención:</strong> Tienes ${t.size} pregunta(s) incorrecta(s) que debes repasar en tu próximo cuestionario.</p>`,n+="</div>"),modalInfoContent.innerHTML=n}function showInfoModal(){displayProgressInfo(),infoModal.style.display="flex"}function closeInfoModal(){infoModal.style.display="none"}function displayQuestion(){if(currentQuestionIndex>=currentQuizQuestions.length)return void showFinalScreen();const e=currentQuizQuestions[currentQuestionIndex];questionText.innerHTML=`<span class="category-tag">Categoría: ${e.category}</span><br>${e.question}`,currentQuestionDisplay.textContent=currentQuestionIndex+1;const t=document.getElementById("question-image");if(t&&t.remove(),e.image){const t=document.createElement("img");t.id="question-image",t.className="question-image",t.src=e.image,t.alt="Imagen de la pregunta",t.loading="lazy",questionText.parentElement.appendChild(t)}answersContainer.innerHTML="";if("text-input"===(e.type||"multiple-choice")){const e=document.createElement("div");e.className="text-input-container";const t=document.createElement("input");t.type="text",t.id="text-answer-input",t.className="text-answer-input",t.placeholder="Escribe tu respuesta aquí...",t.maxLength=50,t.addEventListener("input",()=>{verifyBtn.disabled=0===t.value.trim().length,selectedAnswer=t.value.trim()}),t.addEventListener("keypress",e=>{"Enter"!==e.key||verifyBtn.disabled||verifyAnswer()}),e.appendChild(t),answersContainer.appendChild(e),setTimeout(()=>t.focus(),100)}else{shuffleArray(e.answers).forEach((e,t)=>{const n=document.createElement("div");n.className="answer-option",n.textContent=e.option,n.dataset.correct=e.correct||!1,n.dataset.index=t,n.addEventListener("click",()=>selectAnswer(n)),answersContainer.appendChild(n)})}selectedAnswer=null,verifyBtn.style.display="block",verifyBtn.disabled=!0,nextBtn.style.display="none",feedback.style.display="none"}function selectAnswer(e){selectedAnswer&&selectedAnswer.classList.contains("disabled")||(document.querySelectorAll(".answer-option").forEach(e=>{e.classList.remove("selected")}),e.classList.add("selected"),selectedAnswer=e,verifyBtn.disabled=!1)}function verifyAnswer(){if(!selectedAnswer)return;const e=currentQuizQuestions[currentQuestionIndex];let t=!1;if("text-input"===(e.type||"multiple-choice")){const n=document.getElementById("text-answer-input");t=n.value.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[.,]/g,"")===e.correctAnswer.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[.,]/g,""),n.disabled=!0,n.classList.add(t?"correct-input":"incorrect-input"),t?(feedback.textContent="¡Excelente! 🎉 ¡Respuesta correcta!",feedback.className="correct",score++,scoreDisplay.textContent=score,launchConfetti(),playSuccessSound()):(feedback.textContent=`❌ Respuesta incorrecta. La respuesta correcta es: ${e.correctAnswer}`,feedback.className="incorrect",playErrorSound())}else if(document.querySelectorAll(".answer-option").forEach(e=>{e.classList.add("disabled")}),t="true"===selectedAnswer.dataset.correct,t)selectedAnswer.classList.add("correct"),feedback.textContent="¡Excelente! 🎉 ¡Respuesta correcta!",feedback.className="correct",score++,scoreDisplay.textContent=score,launchConfetti(),playSuccessSound();else{selectedAnswer.classList.add("incorrect");const e=Array.from(document.querySelectorAll(".answer-option")).find(e=>"true"===e.dataset.correct);e&&e.classList.add("correct"),feedback.textContent=`Ups... La respuesta correcta era:\n${e.textContent}`,feedback.className="incorrect",playErrorSound()}saveQuestionResult(e.id,t),feedback.style.display="block",verifyBtn.style.display="none",nextBtn.style.display="block"}function nextQuestion(){currentQuestionIndex++,displayQuestion()}function showFinalScreen(){quizContainer.style.display="none",finalScreen.style.display="block";const e=Math.round(score/currentQuizQuestions.length*100),t=getProgressStats();let n=`\n        <p>Obtuviste <strong>${score}</strong> de <strong>${currentQuizQuestions.length}</strong> respuestas correctas</p>\n        <p style="font-size: 2rem; margin-top: 15px;">${e}%</p>\n        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">\n            <h3>📊 Tu Progreso General</h3>\n            <p>Total de preguntas en el banco: <strong>${t.total}</strong></p>\n            <p>Preguntas respondidas: <strong>${t.answered}</strong></p>\n            <p>Preguntas restantes: <strong style="color: #4ecdc4;">${t.remaining}</strong></p>\n    `;t.incorrect>0&&(n+=`<p style="color: #ff6b6b;">Preguntas para repasar: <strong>${t.incorrect}</strong></p>`),n+="</div>",t.remaining>0||t.incorrect>0?n+='<p style="margin-top: 15px; color: #666;">💡 ¡Puedes hacer otro cuestionario!</p>':n+='<p style="margin-top: 15px; color: #4ecdc4;">🎉 ¡Has completado todas las preguntas! Presiona "Reiniciar Todo" para comenzar de nuevo.</p>',finalScoreDisplay.innerHTML=n,e>=70&&(launchConfetti(),playSuccessSound()),0===t.remaining&&0===t.incorrect?restartBtn.textContent="Reiniciar Todo":restartBtn.textContent="Nuevo Cuestionario"}function restartQuiz(){const e=getProgressStats();0===e.remaining&&0===e.incorrect&&confirm("¿Deseas reiniciar todo tu progreso y comenzar desde cero?")&&resetProgress(),currentQuestionIndex=0,score=0,scoreDisplay.textContent="0",currentQuizQuestions=selectQuestions(),totalQuestionsDisplay.textContent=currentQuizQuestions.length,finalScreen.style.display="none",quizContainer.style.display="block",displayQuestion()}function launchConfetti(){const e=confettiCanvas,t=e.getContext("2d");e.width=window.innerWidth,e.height=window.innerHeight;const n=[],s=["#ff6b6b","#4ecdc4","#45b7d1","#feca57","#ff9ff3","#54a0ff"];for(let t=0;t<100;t++)n.push({x:Math.random()*e.width,y:Math.random()*e.height-e.height,size:6*Math.random()+4,speedY:3*Math.random()+2,speedX:2*Math.random()-1,color:s[Math.floor(Math.random()*s.length)],rotation:360*Math.random(),rotationSpeed:10*Math.random()-5});let r=0;!function s(){t.clearRect(0,0,e.width,e.height),n.forEach(e=>{t.save(),t.translate(e.x,e.y),t.rotate(e.rotation*Math.PI/180),t.fillStyle=e.color,t.fillRect(-e.size/2,-e.size/2,e.size,e.size),t.restore(),e.y+=e.speedY,e.x+=e.speedX,e.rotation+=e.rotationSpeed,e.speedY+=.1}),r++,r<150?requestAnimationFrame(s):t.clearRect(0,0,e.width,e.height)}()}function playSuccessSound(){const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=523.25,t.type="sine",n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),t.start(e.currentTime),t.stop(e.currentTime+.5),setTimeout(()=>{const t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=659.25,t.type="sine",n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.5),t.start(e.currentTime),t.stop(e.currentTime+.5)},100)}function playErrorSound(){const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.value=200,t.type="sawtooth",n.gain.setValueAtTime(.3,e.currentTime),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.3),t.start(e.currentTime),t.stop(e.currentTime+.3)}verifyBtn.addEventListener("click",verifyAnswer),nextBtn.addEventListener("click",nextQuestion),restartBtn.addEventListener("click",restartQuiz),infoBtn.addEventListener("click",showInfoModal),closeModal.addEventListener("click",closeInfoModal),window.addEventListener("click",e=>{e.target===infoModal&&closeInfoModal()}),window.addEventListener("resize",()=>{confettiCanvas.width=window.innerWidth,confettiCanvas.height=window.innerHeight});const clearSessionLink=document.getElementById("clear-session-link");clearSessionLink&&clearSessionLink.addEventListener("click",e=>{e.preventDefault(),confirm("¿Estás seguro de que quieres limpiar toda la sesión? Se perderá todo tu progreso.")&&(resetProgress(),location.reload())}),loadQuestions();